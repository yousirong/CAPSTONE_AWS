!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SearchAddon=t():e.SearchAddon=t()}(self,(function(){return(()=>{"use strict";var e={};return(()=>{var t=e;Object.defineProperty(t,"__esModule",{value:!0}),t.SearchAddon=void 0;var i=" ~!@#$%^&*()+`-=[]{}|\\;:\"',./<>?",r=function(){function e(){this._dataChanged=!1,this._resultDecorations=new Map,this._searchResults=new Map,this._linesCacheTimeoutId=0}return e.prototype.activate=function(e){var t=this;this._terminal=e,this._onDataDisposable=this._terminal.onData((function(){t._dataChanged=!0,t._highlightTimeout&&window.clearTimeout(t._highlightTimeout),t._highlightTimeout=setTimeout((function(){var e;(null===(e=t._lastSearchOptions)||void 0===e?void 0:e.decorations)&&t._cachedSearchTerm&&t._resultDecorations.size>0&&t._lastSearchOptions&&t._highlightAllMatches(t._cachedSearchTerm,t._lastSearchOptions)}),200)}))},e.prototype.dispose=function(){var e;this.clearDecorations(),null===(e=this._onDataDisposable)||void 0===e||e.dispose()},e.prototype.clearDecorations=function(){var e,t;null===(e=this._selectedDecoration)||void 0===e||e.dispose(),null===(t=this._terminal)||void 0===t||t.clearSelection(),this._searchResults.clear(),this._disposeDecorations(),this._cachedSearchTerm=void 0,this._dataChanged=!0},e.prototype._disposeDecorations=function(){this._resultDecorations.forEach((function(e){for(var t=0,i=e;t<i.length;t++)i[t].dispose()})),this._resultDecorations.clear()},e.prototype.findNext=function(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");this._lastSearchOptions=t;var i=this._findNextAndSelect(e,t);return(null==t?void 0:t.decorations)&&this._highlightAllMatches(e,t),i},e.prototype._highlightAllMatches=function(e,t){var i=this;if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(e&&0!==e.length){if(t=t||{},e!==this._cachedSearchTerm||this._dataChanged){this._disposeDecorations(),this._searchResults.clear();for(var r=this._find(e,0,0,t);r&&!this._searchResults.get(r.row+"-"+r.col);)this._searchResults.set(r.row+"-"+r.col,r),r=this._find(e,r.col+r.term.length>=this._terminal.cols?r.row+1:r.row,r.col+r.term.length>=this._terminal.cols?0:r.col+1,t);this._searchResults.forEach((function(e){var r=i._createResultDecoration(e,t.decorations);if(r){var n=i._resultDecorations.get(r.marker.line)||[];n.push(r),i._resultDecorations.set(r.marker.line,n)}})),this._dataChanged&&(this._dataChanged=!1),this._searchResults.size>0&&(this._cachedSearchTerm=e)}}else this.clearDecorations()},e.prototype._find=function(e,t,i,r){var n;if(!this._terminal||!e||0===e.length)return null===(n=this._terminal)||void 0===n||n.clearSelection(),void this.clearDecorations();if(i>this._terminal.cols)throw new Error("Invalid col: "+i+" to search in terminal of "+this._terminal.cols+" cols");var o=void 0;this._initLinesCache();var s={startRow:t,startCol:i};if(!(o=this._findInLine(e,s,r)))for(var a=t+1;a<this._terminal.buffer.active.baseY+this._terminal.rows&&(s.startRow=a,s.startCol=0,!(o=this._findInLine(e,s,r)));a++);return o},e.prototype._findNextAndSelect=function(e,t){var i;if(!this._terminal||!e||0===e.length)return null===(i=this._terminal)||void 0===i||i.clearSelection(),this.clearDecorations(),!1;var r,n=0,o=0;if(this._terminal.hasSelection()){var s=!!t&&t.incremental;r=this._terminal.getSelectionPosition(),o=s?r.startRow:r.endRow,n=s?r.startColumn:r.endColumn}this._initLinesCache();var a={startRow:o,startCol:n},l=this._findInLine(e,a,t);if(!l)for(var h=o+1;h<this._terminal.buffer.active.baseY+this._terminal.rows&&(a.startRow=h,a.startCol=0,!(l=this._findInLine(e,a,t)));h++);if(!l&&0!==o)for(h=0;h<o&&(a.startRow=h,a.startCol=0,!(l=this._findInLine(e,a,t)));h++);return!l&&r&&(a.startRow=r.startRow,a.startCol=0,l=this._findInLine(e,a,t)),this._selectResult(l,null==t?void 0:t.decorations)},e.prototype.findPrevious=function(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");this._lastSearchOptions=t;var i=this._findAndSelectPrevious(e,t);return(null==t?void 0:t.decorations)&&this._highlightAllMatches(e,t),i},e.prototype._findAndSelectPrevious=function(e,t){var i,r;if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(!this._terminal||!e||0===e.length)return r=void 0,null===(i=this._terminal)||void 0===i||i.clearSelection(),this.clearDecorations(),!1;var n,o=this._terminal.buffer.active.baseY+this._terminal.rows,s=this._terminal.cols,a=!0,l=!!t&&t.incremental;this._terminal.hasSelection()&&(o=(n=this._terminal.getSelectionPosition()).startRow,s=n.startColumn),this._initLinesCache();var h={startRow:o,startCol:s};if(l?(r=this._findInLine(e,h,t,!1))&&r.row===o&&r.col===s||(n&&(h.startRow=n.endRow,h.startCol=n.endColumn),r=this._findInLine(e,h,t,!0)):r=this._findInLine(e,h,t,a),!r){h.startCol=Math.max(h.startCol,this._terminal.cols);for(var c=o-1;c>=0&&(h.startRow=c,!(r=this._findInLine(e,h,t,a)));c--);}if(!r&&o!==this._terminal.buffer.active.baseY+this._terminal.rows)for(c=this._terminal.buffer.active.baseY+this._terminal.rows;c>=o&&(h.startRow=c,!(r=this._findInLine(e,h,t,a)));c--);return!(r||!n)||this._selectResult(r,null==t?void 0:t.decorations)},e.prototype._initLinesCache=function(){var e=this,t=this._terminal;this._linesCache||(this._linesCache=new Array(t.buffer.active.length),this._cursorMoveListener=t.onCursorMove((function(){return e._destroyLinesCache()})),this._resizeListener=t.onResize((function(){return e._destroyLinesCache()}))),window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=window.setTimeout((function(){return e._destroyLinesCache()}),15e3)},e.prototype._destroyLinesCache=function(){this._linesCache=void 0,this._cursorMoveListener&&(this._cursorMoveListener.dispose(),this._cursorMoveListener=void 0),this._resizeListener&&(this._resizeListener.dispose(),this._resizeListener=void 0),this._linesCacheTimeoutId&&(window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=0)},e.prototype._isWholeWord=function(e,t,r){return(0===e||i.includes(t[e-1]))&&(e+r.length===t.length||i.includes(t[e+r.length]))},e.prototype._findInLine=function(e,t,i,r){var n;void 0===i&&(i={}),void 0===r&&(r=!1);var o=this._terminal,s=t.startRow,a=t.startCol,l=o.buffer.active.getLine(s);if(null==l?void 0:l.isWrapped)return r?void(t.startCol+=o.cols):(t.startRow--,t.startCol+=o.cols,this._findInLine(e,t,i));var h=null===(n=this._linesCache)||void 0===n?void 0:n[s];h||(h=this._translateBufferLineToStringWithWrap(s,!0),this._linesCache&&(this._linesCache[s]=h));var c=h[0],d=h[1],u=this._bufferColsToStringOffset(s,a),f=i.caseSensitive?e:e.toLowerCase(),_=i.caseSensitive?c:c.toLowerCase(),v=-1;if(i.regex){var p=RegExp(f,"g"),g=void 0;if(r)for(;g=p.exec(_.slice(0,u));)v=p.lastIndex-g[0].length,e=g[0],p.lastIndex-=e.length-1;else(g=p.exec(_.slice(u)))&&g[0].length>0&&(v=u+(p.lastIndex-g[0].length),e=g[0])}else r?u-f.length>=0&&(v=_.lastIndexOf(f,u-f.length)):v=_.indexOf(f,u);if(v>=0){if(i.wholeWord&&!this._isWholeWord(v,_,e))return;for(var m=0;m<d.length-1&&v>=d[m+1];)m++;for(var w=m;w<d.length-1&&v+e.length>=d[w+1];)w++;var C=v-d[m],L=v+e.length-d[w],b=this._stringLengthToBufferSize(s+m,C);return{term:e,col:b,row:s+m,size:this._stringLengthToBufferSize(s+w,L)-b+o.cols*(w-m)}}},e.prototype._stringLengthToBufferSize=function(e,t){var i=this._terminal.buffer.active.getLine(e);if(!i)return 0;for(var r=0;r<t;r++){var n=i.getCell(r);if(!n)break;var o=n.getChars();o.length>1&&(t-=o.length-1);var s=i.getCell(r+1);s&&0===s.getWidth()&&t++}return t},e.prototype._bufferColsToStringOffset=function(e,t){for(var i=this._terminal,r=e,n=0,o=i.buffer.active.getLine(r);t>0&&o;){for(var s=0;s<t&&s<i.cols;s++){var a=o.getCell(s);if(!a)break;a.getWidth()&&(n+=a.getChars().length)}if(r++,(o=i.buffer.active.getLine(r))&&!o.isWrapped)break;t-=i.cols}return n},e.prototype._translateBufferLineToStringWithWrap=function(e,t){for(var i,r=this._terminal,n=[],o=[0],s=r.buffer.active.getLine(e);s;){var a=r.buffer.active.getLine(e+1),l=!!a&&a.isWrapped,h=s.translateToString(!l&&t);if(l&&a){var c=s.getCell(s.length-1);c&&0===c.getCode()&&1===c.getWidth()&&2===(null===(i=a.getCell(0))||void 0===i?void 0:i.getWidth())&&(h=h.slice(0,-1))}if(n.push(h),!l)break;o.push(o[o.length-1]+h.length),e++,s=a}return[n.join(""),o]},e.prototype._selectResult=function(e,t){var i,r,n,o=this,s=this._terminal;if(null===(i=this._selectedDecoration)||void 0===i||i.dispose(),!e)return s.clearSelection(),!1;if(s.select(e.col,e.row,e.size),null==t?void 0:t.activeMatchColorOverviewRuler){var a=s.registerMarker(-s.buffer.active.baseY-s.buffer.active.cursorY+e.row);a&&(this._selectedDecoration=s.registerDecoration({marker:a,x:e.col,width:e.size,overviewRulerOptions:{color:t.activeMatchColorOverviewRuler}}),null===(r=this._selectedDecoration)||void 0===r||r.onRender((function(i){return o._applyStyles(i,t.activeMatchBackground,t.activeMatchBorder,e)})),null===(n=this._selectedDecoration)||void 0===n||n.onDispose((function(){return a.dispose()})))}if(e.row>=s.buffer.active.viewportY+s.rows||e.row<s.buffer.active.viewportY){var l=e.row-s.buffer.active.viewportY;l-=Math.floor(s.rows/2),s.scrollLines(l)}return!0},e.prototype._applyStyles=function(e,t,i,r){e.clientWidth<=0||e.classList.contains("xterm-find-result-decoration")||(e.classList.add("xterm-find-result-decoration"),t&&(e.style.backgroundColor=t),i&&(e.style.outline="1px solid "+i))},e.prototype._createResultDecoration=function(e,t){var i=this,r=this._terminal,n=r.registerMarker(-r.buffer.active.baseY-r.buffer.active.cursorY+e.row);if(n&&(null==t?void 0:t.matchOverviewRuler)){var o=r.registerDecoration({marker:n,x:e.col,width:e.size,overviewRulerOptions:this._resultDecorations.get(n.line)&&!this._dataChanged?void 0:{color:t.matchOverviewRuler,position:"center"}});return null==o||o.onRender((function(r){return i._applyStyles(r,t.matchBackground,t.matchBorder,e)})),null==o||o.onDispose((function(){return n.dispose()})),o}},e}();t.SearchAddon=r})(),e})()}));